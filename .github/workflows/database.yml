name: ğŸ›¢ï¸ Deploy Database

on:
  push:
    branches:
      - develop # alterar em prod para main
    paths:
      - 'infra/database/**' 
      - '.github/workflows/database.yml'
  pull_request:
    branches:
      - develop # alterar em prod para main
    paths:
      - 'infra/database/**'

jobs:
  terraform:
    name: "ğŸ›¢ï¸ Deploy RDS Infrastructure"
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: ./infra/database

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ›¡ï¸ Verify Secrets & Variables
        run: |
          if [[ -z "${{ secrets.DB_USERNAME }}" ]]; then echo "âŒ Erro: Secret DB_USERNAME estÃ¡ vazia."; exit 1; fi
          if [[ -z "${{ secrets.DB_PASSWORD }}" ]]; then echo "âŒ Erro: Secret DB_PASSWORD estÃ¡ vazia."; exit 1; fi
          if [[ -z "${{ secrets.DB_PG_NAME }}" ]]; then echo "âŒ Erro: DB_PG_NAME estÃ¡ vazia."; exit 1; fi
          if [[ -z "${{ secrets.PROJECT_NAME_DATABASE }}" ]]; then echo "âŒ Erro: PROJECT_NAME_DATABASE estÃ¡ vazia."; exit 1; fi
          echo "âœ… Todas as variÃ¡veis obrigatÃ³rias estÃ£o presentes."

      - name: ğŸ”‘ Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: us-east-1

      - name: ğŸ” Verify AWS Identity
        run: |
          echo "ğŸ” Verificando identidade AWS..."
          aws sts get-caller-identity
          echo "âœ… Credenciais AWS configuradas com sucesso!"

      - name: ğŸ› ï¸ Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: ğŸ§­ Determine Workspace
        id: context
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BRANCH_NAME=${{ github.base_ref }}
          else
            BRANCH_NAME=${{ github.ref_name }}
          fi
          
          case "$BRANCH_NAME" in
            develop) WORKSPACE="dev" ;; # alterar em prod para main
            main) WORKSPACE="main" ;;
            qa) WORKSPACE="qa" ;;
            *) WORKSPACE="$BRANCH_NAME" ;;
          esac

          echo "Target Workspace: $WORKSPACE"
          echo "TARGET_WORKSPACE=$WORKSPACE" >> $GITHUB_ENV

      - name: ğŸª£ Bootstrap Infrastructure
        run: |
          echo "ğŸ”§ Executando bootstrap para workspace: ${{ env.TARGET_WORKSPACE }}"
          
          chmod +x bootstrap.sh
          ./bootstrap.sh ${{ env.TARGET_WORKSPACE }}

          echo "âœ… Bootstrap finalizado."

      - name: ğŸ§ª Validate Bootstrap State
        run: |
          if [ -d ".terraform" ]; then
            echo "âœ… Terraform inicializado corretamente."
          else
            echo "âŒ Erro: Pasta .terraform nÃ£o encontrada."
            exit 1
          fi

          echo "ğŸ”„ Configurando Workspace: ${{ env.TARGET_WORKSPACE }}"

          terraform workspace select ${{ env.TARGET_WORKSPACE }} || terraform workspace new ${{ env.TARGET_WORKSPACE }}

          echo "TF_WORKSPACE=${{ env.TARGET_WORKSPACE }}" >> $GITHUB_ENV

      - name: âš™ï¸ Set Terraform Variables
        run: |
          echo "TF_VAR_db_username=${{ secrets.DB_USERNAME }}" >> $GITHUB_ENV
          echo "TF_VAR_db_password=${{ secrets.DB_PASSWORD }}" >> $GITHUB_ENV
          echo "TF_VAR_db_name=${{ secrets.DB_PG_NAME }}" >> $GITHUB_ENV
          echo "TF_VAR_project_name=${{ secrets.PROJECT_NAME_DATABASE }}" >> $GITHUB_ENV

      - name: ğŸ” Terraform Validate
        run: terraform validate -no-color

      - name: ğŸ“‹ Terraform Plan (Dry Run)
        id: plan
        run: |
          echo "Executando Plan para o ambiente: ${{ env.TF_WORKSPACE }}"
          terraform plan -out=tfplan -input=false -no-color

      - name: ğŸš€ Terraform Apply
        if: github.event_name == 'push' && github.ref == 'refs/heads/develop' # alterar em prod para main
        run: |
          echo "ğŸš€ Aplicando mudanÃ§as no ambiente: ${{ env.TF_WORKSPACE }}"
          terraform apply -auto-approve -input=false -no-color tfplan