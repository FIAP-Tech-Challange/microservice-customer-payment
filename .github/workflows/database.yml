name: "Terraform CI/CD"

on:
  pull_request:
    branches:
      - main
      - qa
      - develop

  push:
    branches:
      - main
      - qa
      - develop

jobs:
  terraform:
    name: "Terraform Plan/Apply"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: us-east-1

      - name: Verify Local AWS CLI Installation
        if: env.ACT == 'true'
        run: |
          echo "Running under act, installing AWS CLI..."
          sudo apt-get update -y
          sudo apt-get install -y unzip curl less
          curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
          unzip -q awscliv2.zip
          sudo ./aws/install

      - name: ðŸ” Verify AWS Identity
        run: |
          echo "ðŸ” Verificando identidade AWS..."
          aws sts get-caller-identity
          echo "âœ… Credenciais AWS configuradas com sucesso!"

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: ðŸš€ Bootstrap Infrastructure
        id: bootstrap
        run: |
          echo "ðŸ”§ Executando bootstrap da infraestrutura..."

          # Determinar workspace baseado na branch
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BRANCH_NAME=${{ github.base_ref }}
          else
            BRANCH_NAME=${{ github.ref_name }}
          fi

          case "$BRANCH_NAME" in
            develop) WORKSPACE="dev" ;;
            main) WORKSPACE="main" ;;
            qa) WORKSPACE="qa" ;;
            *) WORKSPACE="$BRANCH_NAME" ;;
          esac

          echo "ðŸŽ¯ Workspace detectado: $WORKSPACE"

          # Dar permissÃ£o de execuÃ§Ã£o aos scripts
          chmod +x bootstrap.sh config.sh

          # Executar bootstrap com workspace especÃ­fico
          ./bootstrap.sh $WORKSPACE

          echo "âœ… Bootstrap executado com sucesso!"

      - name: ðŸ§ª Validate Bootstrap
        run: |
          echo "ðŸ” Validando se bootstrap foi bem-sucedido..."

          # Verificar se Terraform foi inicializado
          if [ -d ".terraform" ]; then
            echo "âœ… Terraform inicializado"
          else
            echo "âŒ Terraform nÃ£o foi inicializado"
            exit 1
          fi

          # Verificar workspaces disponÃ­veis
          echo "ðŸ“‚ Workspaces disponÃ­veis:"
          terraform workspace list

      - name: ðŸŽ¯ Select Terraform Workspace
        id: workspace
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BRANCH_NAME=${{ github.base_ref }}
          else
            BRANCH_NAME=${{ github.ref_name }}
          fi

          echo "Branch detectada: $BRANCH_NAME"

          # Mapeia nomes de branch para workspaces Terraform
          case "$BRANCH_NAME" in
            develop) WORKSPACE="dev" ;;
            main) WORKSPACE="main" ;;
            qa) WORKSPACE="qa" ;;
            *) WORKSPACE="$BRANCH_NAME" ;; # fallback
          esac

          echo "Workspace: $WORKSPACE"

          # O bootstrap jÃ¡ criou o workspace, mas vamos garantir que estamos no correto
          terraform workspace select "$WORKSPACE" || terraform workspace new "$WORKSPACE"

      - name: Set Terraform Variables
        run: |
          # Nome do projeto = nome do repositÃ³rio
          REPO_NAME=$(echo "${GITHUB_REPOSITORY}" | cut -d'/' -f2)
          echo "TF_VAR_project_name=$REPO_NAME" >> $GITHUB_ENV

          # Nome de usuÃ¡rio do banco = secret
          echo "TF_VAR_db_username=${{ secrets.DB_USERNAME }}" >> $GITHUB_ENV

          # Senha do banco = secret
          echo "TF_VAR_db_password=${{ secrets.DB_PASSWORD }}" >> $GITHUB_ENV

      - name: Terraform Validate
        run: terraform validate -no-color

      - name: Terraform Plan
        id: plan
        run: terraform plan -no-color -input=false

      - name: Terraform Apply
        if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/qa' || github.ref == 'refs/heads/develop')
        run: terraform apply -auto-approve -input=false -no-color
